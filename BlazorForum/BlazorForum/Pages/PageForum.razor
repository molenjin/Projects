@page "/forum"

@using BlazorForum.Data
@using BlazorForum.Database
@using BlazorForum.Libraries
@using BlazorForum.Components

@inject IDatabaseCalls DatabaseCalls
@inject LibFormat LibData
@inject LibFormat LibFormat

<PageTitle>Forum</PageTitle>

<div class="forum_content">
    <div class="forum">

        <CompForumHeader ForumLinkOn=false ActionTitle="Start new topic" ActionLinkOn=true ActionLink="/new"></CompForumHeader>

        <br />
        <br />
        <big>

        @if (@topicList != null)
        {
            foreach (var topic in @topicList)
            {
                string topicTitle = LibFormat.HtmlDecode(topic.Title);
                string topicName = LibFormat.HtmlDecode(topic.Name);
                string topicLink = $"/topic/{topic.Id}/{LibFormat.TitleLink(topic.Title)}{LibFormat.NumberOfCommentsLink(topic.NumOfComments)}";
                string topicHidden = LibFormat.HiddenText(topic.Hidden);

                <span>@topicHidden<a class="topiclist forum_topic" href=@topicLink>@topicTitle</a> - @topicName</span>

                if (@LibFormat.FlagExists(@topic.CountryCode))
                {
                    <span>&nbsp;<img src=@LibFormat.FlagLink(@topic.CountryCode)></span>
                }
                <span>&nbsp;@LibFormat.NumberOfCommentsText(@topic.NumOfComments)</span>
                <br />
            }            
        }

        </big>
        <br />

        <button class="btn btn-primary" @onclick=OnLoadMoreAsync hidden=@loadMoreButtonStyle>Load More</button>

        <br />
        <br />
    </div>

    <br />
    <br />
</div>

@code {
    private int numOfTopics = 0;
    private int pageNo = 1;
    private const int pageSize = 50;
    private List<Topic>? topicList;
    private bool loadMoreButtonStyle = true;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        try
        {
            numOfTopics = await DatabaseCalls.GetNumOfTopicsAsync(true);
            topicList = await DatabaseCalls.GetTopicListAsync(true, pageNo, pageSize);

            loadMoreButtonStyle = (pageNo * pageSize) < numOfTopics ? false : true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    async Task OnLoadMoreAsync()
    {
        List<Topic>? additionalTopicList;

        try
        {
            if (topicList != null)
            {
                pageNo++;
                additionalTopicList = await DatabaseCalls.GetTopicListAsync(true, pageNo, pageSize);
                topicList.AddRange(additionalTopicList);

                loadMoreButtonStyle = (pageNo * pageSize) < numOfTopics ? false : true;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }
}